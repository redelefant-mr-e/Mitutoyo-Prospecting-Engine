#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

const DATA_DIR = './public/data';
const MANIFEST_FILE = './public/data/file-manifest.json';

function updateFileIndex() {
  console.log('🔄 Updating file manifest...');
  
  try {
    // Read existing manifest if it exists
    let existingManifest = { files: [], lastUpdated: '', version: '1.0', autoGenerated: true };
    if (fs.existsSync(MANIFEST_FILE)) {
      existingManifest = JSON.parse(fs.readFileSync(MANIFEST_FILE, 'utf8'));
    }
    
    // Scan for CSV files
    const csvFiles = [];
    const files = fs.readdirSync(DATA_DIR);
    
    files.forEach(file => {
      if (file.endsWith('.csv')) {
        // Try to find existing metadata
        const existingFile = existingManifest.files.find(f => f.name === file);
        
        csvFiles.push({
          name: file,
          displayName: existingFile?.displayName || file.replace('.csv', ''),
          description: existingFile?.description || `CSV data file: ${file}`
        });
      }
    });
    
    // Create new manifest
    const newManifest = {
      files: csvFiles,
      lastUpdated: new Date().toISOString(),
      version: '1.0',
      autoGenerated: true
    };
    
    // Write the manifest file
    fs.writeFileSync(MANIFEST_FILE, JSON.stringify(newManifest, null, 2));
    
    console.log(`✅ Updated file manifest with ${csvFiles.length} CSV files:`);
    csvFiles.forEach(file => {
      console.log(`   📄 ${file.name} -> ${file.displayName}`);
    });
    
    console.log(`\n📋 File manifest saved to: ${MANIFEST_FILE}`);
    console.log('🚀 You can now commit and push to update the app!');
    
  } catch (error) {
    console.error('❌ Error updating file index:', error);
    process.exit(1);
  }
}

// Run the update
updateFileIndex();
